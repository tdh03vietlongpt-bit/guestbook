<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>S·ªï L·ªùi Ch√∫c</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f9f6f2;margin:0;padding:20px;text-align:center}
    h1{color:#d6336c}
    form{margin:20px auto;max-width:400px;background:#fff;padding:15px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    input,textarea,button{width:100%;margin:8px 0;padding:10px;border:1px solid #ccc;border-radius:6px}
    button{background:#d6336c;color:#fff;font-weight:700;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .message{margin:10px auto;max-width:700px;text-align:left;background:#fff;padding:12px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
    .message strong{color:#d6336c}
    .time{font-size:12px;color:gray;margin-top:6px;display:block}
    #status{margin-top:8px;color:green}
    #error{margin-top:8px;color:#c00}
  </style>
</head>
<body>
  <h1>üíå S·ªï L·ªùi Ch√∫c</h1>

  <form id="wishForm">
    <input type="text" id="name" placeholder="T√™n c·ªßa b·∫°n" required>
    <textarea id="message" placeholder="Nh·∫≠p l·ªùi ch√∫c..." rows="3" required></textarea>
    <button type="submit" id="sendBtn">G·ª≠i l·ªùi ch√∫c</button>
  </form>

  <div id="status"></div>
  <div id="error"></div>

  <h2>L·ªùi ch√∫c ƒë√£ g·ª≠i:</h2>
  <div id="messages">‚è≥ ƒêang t·∫£i l·ªùi ch√∫c...</div>

  <script>
    const scriptURL = "https://script.google.com/macros/s/AKfycbzrwM11GUMPstnx5WJ-gPjS-Ls8CSZosndewnfX0iu_L8OGH7Ymp307XB9S0LOT1_8VAQ/exec";

    const form = document.getElementById('wishForm');
    const messagesDiv = document.getElementById('messages');
    const statusDiv = document.getElementById('status');
    const errorDiv = document.getElementById('error');
    const sendBtn = document.getElementById('sendBtn');

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      errorDiv.textContent = '';
      statusDiv.textContent = '';
      const name = document.getElementById('name').value.trim();
      const message = document.getElementById('message').value.trim();
      if (!name || !message) return;

      sendBtn.disabled = true;
      sendBtn.textContent = 'ƒêang g·ª≠i...';

      const body = new URLSearchParams();
      body.append('name', name);
      body.append('message', message);

      fetch(scriptURL, {
        method: 'POST',
        body: body
      })
      .then(res => res.json())
      .then(res => {
        if (res && res.status === 'success') {
          statusDiv.textContent = 'G·ª≠i th√†nh c√¥ng ‚úÖ';
          form.reset();
          loadMessages();
        } else {
          errorDiv.textContent = 'Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi ƒë√∫ng t·ª´ server.';
        }
      })
      .catch(err => {
        console.error('POST error:', err);
        errorDiv.textContent = 'L·ªói khi g·ª≠i l·ªùi ch√∫c: ' + err;
      })
      .finally(() => {
        sendBtn.disabled = false;
        sendBtn.textContent = 'G·ª≠i l·ªùi ch√∫c';
      });
    });

    function loadMessages() {
      fetch(scriptURL)
        .then(res => {
          if (!res.ok) throw new Error('HTTP ' + res.status);
          return res.json();
        })
        .then(data => {
          const tempDiv = document.createElement('div');

          if (!Array.isArray(data) || data.length === 0) {
            tempDiv.textContent = 'Ch∆∞a c√≥ l·ªùi ch√∫c n√†o.';
          } else {
            data.reverse().forEach(item => {
              const div = document.createElement('div');
              div.className = 'message';
              div.innerHTML = `<strong>${escapeHtml(item.name)}</strong>: ${escapeHtml(item.message)}<span class="time">${item.time || ''}</span>`;
              tempDiv.appendChild(div);
            });
          }

          // ch·ªâ thay th·∫ø khi d·ªØ li·ªáu m·ªõi ƒë√£ s·∫µn s√†ng
          messagesDiv.innerHTML = tempDiv.innerHTML;
        })
        .catch(err => {
          console.error('GET error:', err);
          errorDiv.textContent = 'L·ªói khi l·∫•y d·ªØ li·ªáu: ' + err;
        });
    }

    function escapeHtml(str) {
      if (!str) return '';
      return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    loadMessages();
    setInterval(loadMessages, 10000);
  </script>
</body>
</html>
